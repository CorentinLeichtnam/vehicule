<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificateur de Trajet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 40px auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        h1 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 30px;
        }
        form {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        #result {
            background: #0056b3;
            color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        #result h4 {
            margin-bottom: 10px;
            font-weight: bold;
        }
        #map {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .btn-primary {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .station-popup {
            font-weight: bold;
            color: #0056b3;
        }
        .station-popup p {
            margin: 5px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Planificateur de Trajet</h1>
        <form method="POST">
            <div class="form-group">
                <label for="start_city">Ville de départ</label>
                <input type="text" class="form-control" id="start_city" name="start_city" required>
            </div>
            <div class="form-group">
                <label for="end_city">Ville d'arrivée</label>
                <input type="text" class="form-control" id="end_city" name="end_city" required>
            </div>
            <div class="form-group">
                <label for="vehicle_id">Choisir un véhicule</label>
                <select class="form-control" id="vehicle_id" name="vehicle_id" required>
                    {% for vehicle in vehicles %}
                    <option value="{{ vehicle.id }}">{{ vehicle.naming.make }} {{ vehicle.naming.model }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Calculer l'itinéraire</button>
        </form>
        
        <div id="result" class="result-card">
            <h4>Informations sur le Trajet</h4>
            <p id="distance"></p>
            <p id="duration"></p>
        </div>

        <div id="map"></div>
    </div>

    <script>
        $(document).ready(function() {
            var map = L.map('map').setView([48.8566, 2.3522], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            $('form').submit(function(event) {
                event.preventDefault();
                var formData = $(this).serialize();

                $.post('/route_data', formData, function(response) {
                    if (response.error) {
                        alert(response.error);
                        return;
                    }

                    var route = response.route;
                    var stations = response.stations;
                    var latlngs = route.map(function(coord) { return [coord[0], coord[1]] });

                    L.polyline(latlngs, {color: 'blue', weight: 5, opacity: 0.7}).addTo(map);

                    stations.forEach(function(station) {
                        var stationCoord = station.location.coordinates;
                        var stationDistance = calculateDistance(latlngs, [stationCoord[1], stationCoord[0]]);
                        
                        L.marker([stationCoord[1], stationCoord[0]]).bindPopup(
                            `<div class="station-popup">
                                <p>${station.name}</p>
                                <p>Distance: ${stationDistance.toFixed(2)} km</p>
                            </div>`
                        ).addTo(map);
                    });

                    L.circleMarker([route[0][0], route[0][1]], {
                        color: 'green',
                        radius: 6,
                        fillColor: 'green',
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("Départ");

                    L.circleMarker([route[route.length - 1][0], route[route.length - 1][1]], {
                        color: 'red',
                        radius: 6,
                        fillColor: 'red',
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("Arrivée");

                    map.fitBounds(L.latLngBounds(latlngs));

                    $('#distance').text('Distance totale : ' + response.distance);
                    $('#duration').text('Durée estimée : ' + response.duration);
                });
            });

            function calculateDistance(route, stationCoord) {
                let minDistance = Infinity;
                route.forEach(function(routeCoord) {
                    const distance = getDistance(routeCoord, stationCoord);
                    if (distance < minDistance) {
                        minDistance = distance;
                    }
                });
                return minDistance;
            }

            function getDistance(coord1, coord2) {
                var R = 6371;
                var dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
                var dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
        });
    </script>
</body>
</html>
